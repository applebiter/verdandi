syntax = "proto3";

package verdandi;

// Common types
message Empty {}

message NodeInfo {
    string node_id = 1;
    string hostname = 2;
    string display_name = 3;
    string daemon_version = 4;
    string cert_fingerprint = 5;
}

message CapabilitySnapshot {
    string cpu_arch = 1;
    int32 cpu_cores = 2;
    int32 ram_total_mb = 3;
    string gpu_vendor = 4;
    string gpu_model = 5;
    int32 vram_mb = 6;
    string os_distro = 7;
    string os_version = 8;
    
    bool supports_stt = 9;
    repeated string stt_backends = 10;
    bool supports_tts = 11;
    repeated string tts_backends = 12;
    bool supports_embeddings = 13;
    repeated string embedding_models = 14;
    bool supports_comfyui = 15;
    bool supports_mcp_server = 16;
    bool supports_mcp_host = 17;
    
    repeated string ollama_models = 18;
    int64 updated_at = 19;
}

message HealthSnapshot {
    double cpu_usage_percent = 1;
    double ram_usage_percent = 2;
    double gpu_usage_percent = 3;
    int32 vram_free_mb = 4;
    int64 daemon_uptime_seconds = 5;
    bool degraded_mode = 6;
    string status = 7;
}

// NodeIdentityService
service NodeIdentityService {
    rpc GetNodeInfo(Empty) returns (NodeInfo);
    rpc Ping(PingRequest) returns (PingResponse);
}

message PingRequest {
    int64 timestamp = 1;
}

message PingResponse {
    int64 timestamp = 1;
    int64 server_timestamp = 2;
}

// HealthMetricsService
service HealthMetricsService {
    rpc GetHealthSnapshot(Empty) returns (HealthSnapshot);
    rpc WatchHealth(WatchHealthRequest) returns (stream HealthEvent);
}

message WatchHealthRequest {
    int32 interval_seconds = 1;  // Update interval
}

message HealthEvent {
    int64 timestamp = 1;
    HealthSnapshot snapshot = 2;
}

// DiscoveryAndRegistryService
service DiscoveryAndRegistryService {
    rpc GetKnownNodes(Empty) returns (KnownNodesResponse);
    rpc WatchPresence(WatchPresenceRequest) returns (stream PresenceEvent);
}

message KnownNodesResponse {
    repeated NodePresence nodes = 1;
}

message NodePresence {
    string node_id = 1;
    string hostname = 2;
    string display_name = 3;
    string ip_address = 4;
    int32 daemon_port = 5;
    int64 last_seen_at = 6;
    string status = 7;
    CapabilitySnapshot capabilities = 8;
}

message WatchPresenceRequest {
    // Empty for now, could add filters
}

message PresenceEvent {
    enum EventType {
        NODE_DISCOVERED = 0;
        NODE_UPDATED = 1;
        NODE_LOST = 2;
    }
    
    EventType event_type = 1;
    NodePresence node = 2;
    int64 timestamp = 3;
}

// FabricGraphService
service FabricGraphService {
    rpc GetFabricGraph(GetFabricGraphRequest) returns (FabricGraphResponse);
    rpc CreateAudioLink(CreateAudioLinkRequest) returns (LinkOperationResponse);
    rpc CreateMidiLink(CreateMidiLinkRequest) returns (LinkOperationResponse);
    rpc RemoveLink(RemoveLinkRequest) returns (LinkOperationResponse);
    rpc GetLinkStatus(GetLinkStatusRequest) returns (LinkStatusResponse);
    rpc ListLinks(Empty) returns (ListLinksResponse);
}

message GetFabricGraphRequest {
    string graph_id = 1;  // Optional, defaults to "Home"
}

message FabricGraphResponse {
    string graph_id = 1;
    string name = 2;
    int32 version = 3;
    repeated FabricLinkInfo links = 4;
    int64 updated_at = 5;
}

message FabricLinkInfo {
    string link_id = 1;
    string link_type = 2;  // AUDIO_JACKTRIP, MIDI_RTP
    string node_a_id = 3;
    string node_b_id = 4;
    string status = 5;
    string params_json = 6;
    repeated BundleInfo bundles = 7;
    int64 created_at = 8;
}

message BundleInfo {
    string bundle_id = 1;
    string name = 2;
    string directionality = 3;  // BIDIR, A_TO_B, B_TO_A
    int32 channels = 4;
    string format = 5;
}

message CreateAudioLinkRequest {
    string node_a_id = 1;
    string node_b_id = 2;
    string params_json = 3;  // JackTrip options
    bool create_voice_cmd_bundle = 4;  // Auto-create voice command bundle
}

message CreateMidiLinkRequest {
    string node_a_id = 1;
    string node_b_id = 2;
    string params_json = 3;  // RTP-MIDI options
}

message RemoveLinkRequest {
    string link_id = 1;
}

message LinkOperationResponse {
    bool success = 1;
    string message = 2;
    string link_id = 3;
}

message GetLinkStatusRequest {
    string link_id = 1;
}

message LinkStatusResponse {
    string link_id = 1;
    string status = 2;
    string observed_status = 3;
    string error_message = 4;
}

message ListLinksResponse {
    repeated FabricLinkInfo links = 1;
}

// JackService - Query and control JACK audio graph
service JackService {
    rpc GetJackGraph(Empty) returns (JackGraphResponse);
    rpc ConnectPorts(ConnectPortsRequest) returns (PortOperationResponse);
    rpc DisconnectPorts(DisconnectPortsRequest) returns (PortOperationResponse);
}

message JackGraphResponse {
    repeated JackClient clients = 1;
    repeated JackConnection connections = 2;
    int32 sample_rate = 3;
    int32 buffer_size = 4;
}

message JackClient {
    string name = 1;
    repeated JackPort input_ports = 2;
    repeated JackPort output_ports = 3;
}

message JackPort {
    string name = 1;
    string full_name = 2;
    bool is_midi = 3;
}

message JackConnection {
    string output_port = 1;
    string input_port = 2;
}

message ConnectPortsRequest {
    string output_port = 1;
    string input_port = 2;
}

message DisconnectPortsRequest {
    string output_port = 1;
    string input_port = 2;
}

message PortOperationResponse {
    bool success = 1;
    string message = 2;
}

// JackTripService - Control JackTrip connections
service JackTripService {
    rpc StartHub(StartHubRequest) returns (JackTripOperationResponse);
    rpc StopHub(StopHubRequest) returns (JackTripOperationResponse);
    rpc StartClient(StartClientRequest) returns (JackTripOperationResponse);
    rpc StopClient(StopClientRequest) returns (JackTripOperationResponse);
    rpc GetJackTripStatus(Empty) returns (JackTripStatusResponse);
}

message StartHubRequest {
    int32 send_channels = 1;
    int32 receive_channels = 2;
    int32 sample_rate = 3;
    int32 buffer_size = 4;
    int32 port = 5;  // Default 4464
}

message StopHubRequest {
    // Empty for now
}

message StartClientRequest {
    string hub_address = 1;
    int32 hub_port = 2;
    int32 send_channels = 3;
    int32 receive_channels = 4;
    int32 sample_rate = 5;
    int32 buffer_size = 6;
}

message StopClientRequest {
    // Empty for now
}

message JackTripOperationResponse {
    bool success = 1;
    string message = 2;
}

message JackTripStatusResponse {
    bool hub_running = 1;
    bool client_running = 2;
    string hub_address = 3;
    int32 hub_port = 4;
    repeated string connected_clients = 5;
}
